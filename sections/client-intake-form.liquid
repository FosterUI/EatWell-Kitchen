{{ 'section-contact-form.css' | asset_url | stylesheet_tag }}

<style>
.account-creation-section {
  margin-top: 3rem;
  padding-top: 2rem;
  border-top: 1px solid var(--color-border);
}

.form-section-title {
  font-size: 1.4rem;
  margin-bottom: 1.5rem;
}

.password-fields {
  margin-bottom: 2rem;
}
</style>

<div class="page-width page-width--narrow">
  <h1 class="title title-wrapper--no-top-margin">{{ page.title }}</h1>
  <p class="form-required-notice">* Required fields</p>

  <client-intake-form class="color-{{ section.settings.color_scheme }} gradient">
    {%- form 'create_customer', id: 'ClientIntakeForm', class: 'isolate' -%}
      {%- if form.posted_successfully? -%}
        <h2 class="form-status form-status-list form__message" tabindex="-1" autofocus>
          {% render 'icon-success' %}
          {{ 'templates.customers.register.success' | t }}
        </h2>
      {%- elsif form.errors -%}
        <div class="form__message">
          <h2 class="form-status caption-large text-body" role="alert" tabindex="-1" autofocus>
            {% render 'icon-error' %}
            {{ form.errors | default_errors }}
          </h2>
        </div>
      {%- endif -%}

      <div class="contact__fields">
        <!-- Personal Information -->
        <div class="field">
          <input
            class="field__input"
            type="text"
            id="FirstName"
            name="customer[first_name]"
            value="{% if form.first_name %}{{ form.first_name }}{% endif %}"
            placeholder="First Name"
            required
          >
          <label class="field__label" for="FirstName">First Name<span class="required-asterisk">*</span></label>
        </div>

        <div class="field">
          <input
            class="field__input"
            type="text"
            id="LastName"
            name="customer[last_name]"
            value="{% if form.last_name %}{{ form.last_name }}{% endif %}"
            placeholder="Last Name"
            required
          >
          <label class="field__label" for="LastName">Last Name<span class="required-asterisk">*</span></label>
        </div>

        <div class="field field--with-error">
          <input
            type="email"
            id="ClientEmail"
            class="field__input"
            name="customer[email]"
            value="{% if form.email %}{{ form.email }}{% endif %}"
            spellcheck="false"
            autocapitalize="off"
            required
            aria-required="true"
            placeholder="Email Address"
          >
          <label class="field__label" for="ClientEmail">Email Address<span class="required-asterisk">*</span></label>
        </div>

        <!-- Store additional fields as customer metafields -->
        <input type="hidden" name="customer[tags]" value="meal-plan-client">

        <div class="field">
          <input
            type="tel"
            id="ClientPhone"
            class="field__input"
            name="customer[phone]"
            pattern="[0-9\-]*"
            placeholder="Phone Number"
            required
          >
          <label class="field__label" for="ClientPhone">Phone Number<span class="required-asterisk">*</span></label>
        </div>

        <!-- Address information stored in customer's default address -->
        <div class="field">
          <input
            class="field__input"
            type="text"
            id="Address"
            name="customer[addresses][0][address1]"
            required
            placeholder="Street Address"
          >
          <label class="field__label" for="Address">Street Address<span class="required-asterisk">*</span></label>
        </div>

        <div class="field">
          <input
            class="field__input"
            type="text"
            id="City"
            name="customer[addresses][0][city]"
            required
            placeholder="City"
          >
          <label class="field__label" for="City">City<span class="required-asterisk">*</span></label>
        </div>

        <div class="field">
          <input
            class="field__input"
            type="text"
            id="State"
            name="customer[addresses][0][province]"
            required
            placeholder="State"
          >
          <label class="field__label" for="State">State<span class="required-asterisk">*</span></label>
        </div>

        <div class="field">
          <input
            class="field__input"
            type="text"
            id="Zipcode"
            name="customer[addresses][0][zip]"
            pattern="[0-9]*"
            required
            placeholder="Zipcode"
          >
          <label class="field__label" for="Zipcode">Zipcode<span class="required-asterisk">*</span></label>
        </div>

        <!-- Store dietary info in customer note -->
        <div class="field">
          <textarea
            rows="3"
            id="Allergies"
            class="text-area field__input"
            name="customer[note][allergies]"
            required
            placeholder="List any food allergies"
          ></textarea>
          <label class="field__label" for="Allergies">Food Allergies<span class="required-asterisk">*</span></label>
        </div>

        <!-- Dietary Restrictions -->
        <div class="field">
          <textarea
            rows="3"
            id="DietaryRestrictions"
            class="text-area field__input"
            name="customer[note][dietary_restrictions]"
            required
            placeholder="List any dietary restrictions"
          ></textarea>
          <label class="field__label" for="DietaryRestrictions"
            >Dietary Restrictions<span class="required-asterisk">*</span></label
          >
        </div>

        <!-- Meal Plan Duration -->
        <div class="field">
          <select class="field__input field__select" id="MealDays" name="customer[note][meal_days]" required>
            <option value="">Select Number of Days</option>
            <option value="5">5 Days</option>
            <option value="7">7 Days</option>
            <option value="10">10 Days</option>
            <option value="30">30 Days</option>
          </select>
          <label class="field__label" for="MealDays">Meal Plan Duration<span class="required-asterisk">*</span></label>
        </div>

        <!-- Meal Types -->
        <div class="field checkbox-group">
          <label class="checkbox-group__label">Meal Types<span class="required-asterisk">*</span></label>
          <div class="checkbox-option">
            <input
              type="checkbox"
              id="MealTypeBreakfast"
              name="customer[note][meal_types][]"
              value="breakfast"
              class="meal-type-checkbox"
            >
            <label for="MealTypeBreakfast">Breakfast</label>
          </div>

          <div class="checkbox-option">
            <input
              type="checkbox"
              id="MealTypeLunch"
              name="customer[note][meal_types][]"
              value="lunch"
              class="meal-type-checkbox"
            >
            <label for="MealTypeLunch">Lunch</label>
          </div>

          <div class="checkbox-option">
            <input
              type="checkbox"
              id="MealTypeDinner"
              name="customer[note][meal_types][]"
              value="dinner"
              class="meal-type-checkbox"
            >
            <label for="MealTypeDinner">Dinner</label>
          </div>

          <div class="checkbox-option">
            <input
              type="checkbox"
              id="MealTypeSnack"
              name="customer[note][meal_types][]"
              value="snack"
              class="meal-type-checkbox"
            >
            <label for="MealTypeSnack">Snack</label>
          </div>
        </div>

        <!-- Food Preferences -->
        <div class="field">
          <textarea
            rows="4"
            id="FoodPreferences"
            class="text-area field__input"
            name="customer[note][food_preferences]"
            required
            placeholder="List foods you particularly like or dislike"
          ></textarea>
          <label class="field__label" for="FoodPreferences"
            >Food Preferences<span class="required-asterisk">*</span></label
          >
        </div>

        <!-- Additional Information -->
        <div class="field">
          <textarea
            rows="4"
            id="AdditionalInfo"
            class="text-area field__input"
            name="customer[note][additional_info]"
            placeholder="Any additional information we should know"
          ></textarea>
          <label class="field__label" for="AdditionalInfo">Additional Information</label>
        </div>
      </div>

      <div class="account-creation-section">
        <h2 class="form-section-title">Create Your Account</h2>

        <div class="password-fields">
          <div class="field">
            <input
              type="password"
              id="CustomerPassword"
              class="field__input"
              name="customer[password]"
              required
              aria-required="true"
              placeholder="Password"
              minlength="5"
            >
            <label class="field__label" for="CustomerPassword">Password<span class="required-asterisk">*</span></label>
          </div>

          <div class="field">
            <input
              type="password"
              id="PasswordConfirmation"
              class="field__input"
              name="customer[password_confirmation]"
              required
              aria-required="true"
              placeholder="Confirm Password"
              minlength="5"
            >
            <label class="field__label" for="PasswordConfirmation"
              >Confirm Password<span class="required-asterisk">*</span></label
            >
          </div>
        </div>
      </div>

      <div class="field checkbox-field">
        <input
          type="checkbox"
          id="AcceptTerms"
          name="customer[accepts_terms]"
          class="field__checkbox"
          required
          aria-required="true"
        >
        <label class="field__label checkbox-label" for="AcceptTerms">
          I agree to the <a href="{{ shop.terms_of_service_url }}" target="_blank">Terms and Conditions</a> and
          <a href="{{ shop.privacy_policy_url }}" target="_blank">Privacy Policy</a
          ><span class="required-asterisk">*</span>
        </label>
      </div>

      <div class="field checkbox-field">
        <input
          type="checkbox"
          id="AcceptMarketing"
          name="customer[accepts_marketing]"
          class="field__checkbox"
        >
        <label class="field__label checkbox-label" for="AcceptMarketing">
          I would like to receive marketing communications about products, services and promotions
        </label>
      </div>

      <div class="contact__button">
        <button type="submit" class="button">Create Account</button>
      </div>
    {%- endform -%}
  </client-intake-form>
</div>

<script>
  class ClientIntakeForm extends HTMLElement {
    constructor() {
      super();
      this.form = this.querySelector('form');
      this.submitButton = this.querySelector('button[type="submit"]');
      this.termsCheckbox = this.querySelector('#AcceptTerms');
      this.passwordInput = this.querySelector('#CustomerPassword');
      this.passwordConfirmInput = this.querySelector('#PasswordConfirmation');
      
      this.setupEventListeners();
    }

    setupEventListeners() {
      this.form.addEventListener('submit', this.handleSubmit.bind(this));
      this.termsCheckbox.addEventListener('change', this.validateForm.bind(this));
      this.passwordInput.addEventListener('input', this.validatePassword.bind(this));
      this.passwordConfirmInput.addEventListener('input', this.validatePassword.bind(this));
    }

    validatePassword() {
      const password = this.passwordInput.value;
      const confirmation = this.passwordConfirmInput.value;
      
      // Validate minimum length
      if (password.length < 5) {
        this.passwordInput.setCustomValidity('Password must be at least 5 characters');
        return false;
      }
      
      // Validate password match
      if (password !== confirmation) {
        this.passwordConfirmInput.setCustomValidity('Passwords do not match');
        return false;
      }

      // Clear validation messages if valid
      this.passwordInput.setCustomValidity('');
      this.passwordConfirmInput.setCustomValidity('');
      return true;
    }

    validateForm() {
      const isTermsAccepted = this.termsCheckbox.checked;
      const isPasswordValid = this.validatePassword();
      
      this.submitButton.disabled = !(isTermsAccepted && isPasswordValid);

      if (!isTermsAccepted) {
        this.termsCheckbox.setCustomValidity('You must accept the Terms and Conditions to continue');
      } else {
        this.termsCheckbox.setCustomValidity('');
      }
    }

    handleSubmit(event) {
      if (!this.validatePassword() || !this.termsCheckbox.checked) {
        event.preventDefault();
        this.passwordInput.reportValidity();
        this.passwordConfirmInput.reportValidity();
        this.termsCheckbox.reportValidity();
      }
    }
  }

  customElements.define('client-intake-form', ClientIntakeForm);
</script>
